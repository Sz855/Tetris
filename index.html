<!DOCTYPE html>
<html>
<head>
    <title>Advanced Battle Tanks</title>
    <style>/* ... предыдущие стили ... */</style>
</head>
<body>
    <canvas id="gameCanvas" width="416" height="416"></canvas>
    <div id="hud">Score: <span id="score">0</span> | Level: <span id="level">1</span></div>
    
    <script>
        // ... предыдущие константы и переменные ...
        
        const POWERUP_TYPES = ['health', 'speed', 'ammo'];
        let powerups = [];
        let score = 0;
        let level = 1;
        let playerHealth = 100;
        let ammoType = 'normal';
        
        // Генерация улучшенной карты
        function generateMap() {
            // Используем клеточный автомат для генерации лабиринта
            let newMap = Array(MAP_SIZE).fill().map(() => 
                Array(MAP_SIZE).fill().map(() => 
                    Math.random() < 0.45 ? TILE_TYPES.BRICK : TILE_TYPES.EMPTY
                )
            );
            
            // Сглаживание
            for(let i = 0; i < 5; i++) {
                newMap = newMap.map((row, y) => row.map((cell, x) => {
                    const neighbors = countNeighbors(newMap, x, y);
                    return neighbors >= 5 ? TILE_TYPES.BRICK : TILE_TYPES.EMPTY;
                }));
            }
            
            // Добавление специальных зон
            addLake(newMap);
            addMaze(newMap);
            map = newMap;
        }
        
        function countNeighbors(map, x, y) {
            let count = 0;
            for(let dy = -1; dy <= 1; dy++) {
                for(let dx = -1; dx <= 1; dx++) {
                    const nx = x + dx;
                    const ny = y + dy;
                    if(nx >= 0 && nx < MAP_SIZE && ny >= 0 && ny < MAP_SIZE && map[ny][nx]) {
                        count++;
                    }
                }
            }
            return count;
        }
        
        // Вражеские танки
        class EnemyTank {
            constructor() {
                this.x = Math.floor(Math.random() * MAP_SIZE) * TILE_SIZE;
                this.y = 0;
                this.direction = Math.floor(Math.random() * 4);
                this.speed = 1 + level * 0.2;
                this.aiState = 'patrol';
                this.shootCooldown = 1000;
                this.lastShot = 0;
            }
            
            update() {
                // Простое ИИ: 30% шанс сменить направление
                if(Math.random() < 0.3) {
                    this.direction = Math.floor(Math.random() * 4);
                }
                
                // Движение
                const move = this.getMoveDirection();
                this.x += move.dx * this.speed;
                this.y += move.dy * this.speed;
                
                // Стрельба
                if(Date.now() - this.lastShot > this.shootCooldown) {
                    this.shoot();
                    this.lastShot = Date.now();
                }
            }
            
            getMoveDirection() {
                const directions = [
                    {dx: 0, dy: -1}, // up
                    {dx: 1, dy: 0},  // right
                    {dx: 0, dy: 1},  // down
                    {dx: -1, dy: 0}  // left
                ];
                return directions[this.direction];
            }
            
            shoot() {
                bullets.push({
                    x: this.x + TILE_SIZE/2,
                    y: this.y + TILE_SIZE/2,
                    direction: this.direction,
                    speed: 4,
                    type: 'enemy'
                });
            }
        }
        
        // Система бонусов
        class Powerup {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.type = POWERUP_TYPES[Math.floor(Math.random() * POWERUP_TYPES.length)];
            }
            
            apply() {
                switch(this.type) {
                    case 'health':
                        playerHealth = Math.min(100, playerHealth + 30);
                        break;
                    case 'speed':
                        player.speed += 0.5;
                        setTimeout(() => player.speed -= 0.5, 10000);
                        break;
                    case 'ammo':
                        ammoType = 'double';
                        setTimeout(() => ammoType = 'normal', 5000);
                        break;
                }
            }
        }
        
        // Расширенная обработка столкновений
        function checkCollision(x, y, type) {
            const tileX = Math.floor(x / TILE_SIZE);
            const tileY = Math.floor(y / TILE_SIZE);
            
            if(tileX < 0 || tileX >= MAP_SIZE || tileY < 0 || tileY >= MAP_SIZE) return true;
            
            const tile = map[tileY][tileX];
            const isObstacle = tile === TILE_TYPES.BRICK || tile === TILE_TYPES.STEEL;
            
            // Проверка воды для движения
            if(type === 'movement' && tile === TILE_TYPES.WATER) return true;
            
            return isObstacle;
        }
        
        // Обновленная система стрельбы
        function fireBullet() {
            if(ammoType === 'double') {
                bullets.push(createBullet(-5), createBullet(5));
            } else {
                bullets.push(createBullet(0));
            }
        }
        
        function createBullet(offset) {
            return {
                x: player.x + TILE_SIZE/2 + offset,
                y: player.y + TILE_SIZE/2 + offset,
                direction: player.direction,
                speed: 5,
                type: 'player'
            };
        }
        
        // Обновленная система уровней
        function nextLevel() {
            level++;
            document.getElementById('level').textContent = level;
            generateMap();
            spawnEnemies();
        }
        
        function spawnEnemies() {
            for(let i = 0; i < 2 + level; i++) {
                enemies.push(new EnemyTank());
            }
        }
        
        // Обновленный игровой цикл
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Обновление объектов
            updatePlayer();
            enemies.forEach(enemy => enemy.update());
            updateBullets();
            updatePowerups();
            
            // Отрисовка
            drawMap();
            drawTank(player, '#00FF00');
            enemies.forEach(enemy => drawTank(enemy, '#FF0000'));
            drawBullets();
            drawPowerups();
            drawHUD();
            
            // Проверка условий уровня
            if(enemies.length === 0) nextLevel();
            
            requestAnimationFrame(gameLoop);
        }
        
        // Звуковые эффекты (используем Web Audio API)
        function playSound(type) {
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            osc.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            switch(type) {
                case 'shoot':
                    osc.frequency.value = 440;
                    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                    break;
                case 'explosion':
                    osc.frequency.value = 100;
                    gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                    break;
            }
            
            osc.start();
            osc.stop(ctx.currentTime + 0.1);
        }
        
        // Инициализация игры
        function initGame() {
            generateMap();
            spawnEnemies();
            gameLoop();
        }
        
        initGame();
    </script>
</body>
</html>
